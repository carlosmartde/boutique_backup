const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const path = require('path');
// Ya no necesitamos escpos para la vista previa

const app = express();
app.use(cors());
const PORT = process.env.PORT || 3000;

// Configuración para parsear JSON
app.use(bodyParser.json());

// Configuración de plantilla para tickets (optimizada para papel de 80mm)
const crearPlantillaTicket = (datos) => {
    try {
        // Extraer datos relevantes del JSON
        const {
            nombreNegocio = 'Mi Negocio',
            direccion = 'Dirección del Negocio',
            telefono = 'Tel: 123456789',
            rfc = 'RFC: XXX0000000XX',
            numeroTicket = '00001',
            fecha = new Date().toLocaleDateString(),
            hora = new Date().toLocaleTimeString(),
            cajero = 'Cajero: Admin',
            productos = [],
            subtotal = 0,
            impuestos = 0,
            total = 0,
            metodoPago = 'Efectivo',
            mensajePie = '¡Gracias por su compra!'
        } = datos;

        // Calcular totales si no vienen en el JSON
        let calculoSubtotal = 0;
        if (productos.length > 0 && subtotal === 0) {
            calculoSubtotal = productos.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        }

        const subtotalFinal = subtotal || calculoSubtotal;
        const impuestosFinal = impuestos || (subtotalFinal * 0.16); // 16% por defecto
        const totalFinal = total || (subtotalFinal + impuestosFinal);

        // Crear el contenido del ticket
        let ticketContent = {
            encabezado: [
                nombreNegocio,
                direccion,
                telefono,
                rfc,
                `Ticket #: ${numeroTicket}`,
                `Fecha: ${fecha}`,
                `Hora: ${hora}`,
                cajero,
                '-'.repeat(32) // Reducido para adaptarse a 80mm
            ],
            cuerpo: productos.map(item => ({
                nombre: item.nombre,
                cantidad: item.cantidad,
                precioUnitario: item.precio,
                importe: item.precio * item.cantidad
            })),
            pie: [
                '-'.repeat(32), // Reducido para adaptarse a 80mm
                `SUBTOTAL: ${subtotalFinal.toFixed(2)}`,
                `IMPUESTOS: ${impuestosFinal.toFixed(2)}`,
                `TOTAL: ${totalFinal.toFixed(2)}`,
                `Método de pago: ${metodoPago}`,
                '-'.repeat(32), // Reducido para adaptarse a 80mm
                mensajePie
            ]
        };

        return ticketContent;
    } catch (error) {
        console.error('Error al crear plantilla:', error);
        throw new Error('Error al procesar los datos para la plantilla del ticket');
    }
};

// Middleware para mostrar vista previa del ticket
app.post('/imprimir', async (req, res) => {
    try {
        const datos = req.body;

        // Validar que haya datos
        if (!datos) {
            return res.status(400).json({ error: 'No se recibieron datos para el ticket' });
        }

        // Crear plantilla de ticket
        const plantillaTicket = crearPlantillaTicket(datos);

        // Configuración de la impresora (solo para mantener la compatibilidad)
        const printerConfig = {
            address: datos.impresora?.ip || '192.168.1.200',
            port: datos.impresora?.puerto || 9100
        };

        // Generar vista previa del ticket
        const vistaPreviaHTML = await imprimirTicket(printerConfig, plantillaTicket);

        res.status(200).json({
            success: true,
            message: 'Vista previa del ticket generada correctamente',
            vistaPrevia: vistaPreviaHTML
        });
    } catch (error) {
        console.error('Error al procesar la solicitud:', error);
        res.status(500).json({
            success: false,
            error: error.message || 'Error al procesar la solicitud'
        });
    }
});

async function imprimirTicket(printerConfig, plantillaTicket) {
    return new Promise((resolve) => {
        try {
            const ANCHO_PAPEL = 32;
            const ticketHTMLStart = `
                <div style="
                    font-family: Courier, monospace;
                    width: 320px;
                    background-color: white;
                    color: black;
                    padding: 10px;
                    border: 1px dashed #ccc;
                    margin: 0 auto;
                    font-size: 12px;
                    line-height: 1.3;
                ">
            `;

            let ticketHTML = ticketHTMLStart;

            // Encabezado
            plantillaTicket.encabezado.forEach(linea => {
                ticketHTML += `<div style="text-align: center; font-weight: bold;">${linea}</div>`;
            });

            // Separador visual
            const separator = '-'.repeat(ANCHO_PAPEL);
            ticketHTML += `<div style="margin-top: 5px; white-space: pre;">PRODUCTO       CANT PRECIO IMPORTE</div>`;
            ticketHTML += `<div style="white-space: pre;">${separator}</div>`;

            // Contenedor del cuerpo tipo tabla
            ticketHTML += `
    <div style="display: flex; font-weight: bold; border-bottom: 1px solid #000; margin-top: 5px;">
        <div style="width: 45%; white-space: nowrap;">PRODUCTO</div>
        <div style="width: 15%; text-align: right;">CANT</div>
        <div style="width: 20%; text-align: right;">PRECIO</div>
        <div style="width: 20%; text-align: right;">IMPORTE</div>
    </div>
`;

            // Detalle de productos con alineación fija
            plantillaTicket.cuerpo.forEach(producto => {
                let nombre = producto.nombre.trim();
                if (nombre.length > 18) {
                    nombre = nombre.slice(0, 15) + '...'; // Ajuste si es muy largo
                }

                const cantidad = producto.cantidad.toString();
                const precio = producto.precioUnitario.toFixed(2);
                const importe = producto.importe.toFixed(2);

                ticketHTML += `
        <div style="display: flex; font-family: monospace;">
            <div style="width: 45%; white-space: nowrap; overflow: hidden;">${nombre}</div>
            <div style="width: 15%; text-align: right;">${cantidad}</div>
            <div style="width: 20%; text-align: right;">${precio}</div>
            <div style="width: 20%; text-align: right;">${importe}</div>
        </div>
    `;
            });


            ticketHTML += `<div style="white-space: pre;">${separator}</div>`;

            // Pie de ticket
            ticketHTML += `<div style="text-align: right; margin-top: 5px;">`;
            plantillaTicket.pie.forEach((linea, index) => {
                const isTotal = index === 2;
                ticketHTML += `<div style="${isTotal ? 'font-weight: bold; font-size: 1.2em;' : ''}">${linea}</div>`;
            });
            ticketHTML += `</div>`;

            // Mensaje final
            ticketHTML += `<div style="text-align: center; margin-top: 10px;">Conserve su ticket</div>`;

            // Línea de corte
            ticketHTML += `
                <div style="
                    text-align: center;
                    margin-top: 10px;
                    font-size: 10px;
                    letter-spacing: 1px;
                ">✂︎─────────────────────────────✂︎</div>
            `;

            ticketHTML += '</div>'; // Cierre del contenedor principal

            resolve(ticketHTML);
        } catch (error) {
            console.error('Error al generar vista previa del ticket:', error);
            resolve('<div>Error al generar vista previa del ticket</div>');
        }
    });
}


// Servir archivos estáticos para la demo
app.use(express.static(path.join(__dirname, 'public')));

// Ruta para la página de demostración
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Ruta para verificar el estado del servidor
app.get('/estado', (req, res) => {
    res.status(200).json({
        status: 'online',
        message: 'Middleware de vista previa de ticket funcionando correctamente'
    });
});

// Iniciar servidor
app.listen(PORT, () => {
    console.log(`Middleware de vista previa de tickets ejecutándose en http://localhost:${PORT}`);
});

module.exports = app;